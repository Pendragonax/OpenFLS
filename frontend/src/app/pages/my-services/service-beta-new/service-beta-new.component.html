<div class="beta-service-page">
  <div class="beta-card">
    <div class="beta-title">Neuer Eintrag</div>

    <div class="beta-section">
      <div class="beta-section-title">Basisdaten</div>
      <form [formGroup]="firstForm">
        <div class="beta-grid beta-grid-3">
          <mat-form-field appearance="outline" class="beta-field">
            <mat-icon matPrefix>calendar_today</mat-icon>
            <mat-label>Datum</mat-label>
            <input matInput
                   formControlName="serviceDate"
                   [matDatepicker]="serviceDatePicker">
            <mat-datepicker-toggle matSuffix [for]="serviceDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #serviceDatePicker></mat-datepicker>
          </mat-form-field>

          <div class="beta-time-group">
            <div class="beta-time-label">Von</div>
            <div class="beta-time-fields">
              <mat-form-field appearance="outline" class="beta-time-field">
                <mat-icon matPrefix>schedule</mat-icon>
                <input matInput type="number" formControlName="startHour" min="0" max="23">
              </mat-form-field>
              <span class="beta-time-sep">:</span>
              <mat-form-field appearance="outline" class="beta-time-field">
                <input matInput type="number" formControlName="startMinute" min="0" max="59">
              </mat-form-field>
            </div>
          </div>

          <div class="beta-time-group">
            <div class="beta-time-label">Bis</div>
            <div class="beta-time-fields">
              <mat-form-field appearance="outline" class="beta-time-field">
                <mat-icon matPrefix>schedule</mat-icon>
                <input matInput type="number" formControlName="endHour" min="0" max="23">
              </mat-form-field>
              <span class="beta-time-sep">:</span>
              <mat-form-field appearance="outline" class="beta-time-field">
                <input matInput type="number" formControlName="endMinute" min="0" max="59">
              </mat-form-field>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="beta-section">
      <div class="beta-section-title">Klient, Bereich & Stundentyp</div>
      <div class="beta-grid beta-grid-3">
        <form [formGroup]="secondForm">
          <mat-form-field appearance="outline" class="beta-field">
            <mat-icon matPrefix>person</mat-icon>
            <mat-label>Klient</mat-label>
            <input matInput
                   type="text"
                   formControlName="client"
                   [matAutocomplete]="clientAuto">
            <mat-autocomplete #clientAuto="matAutocomplete"
                              [displayWith]="displayClient"
                              (optionSelected)="onClientSelected($event.option.value)">
              @for (client of filteredClients; track client.id) {
                <mat-option [value]="client">{{ client.lastName }} {{ client.firstName }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        </form>

        <form [formGroup]="firstForm">
          <mat-form-field appearance="outline" class="beta-field">
            <mat-icon matPrefix>apartment</mat-icon>
            <mat-label>Bereich</mat-label>
            <mat-select formControlName="institution">
              @for (institution of institutions; track institution.id) {
                <mat-option [value]="institution.id">{{ institution.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </form>

        <form [formGroup]="secondForm">
          <mat-form-field appearance="outline" class="beta-field">
            <mat-icon matPrefix>watch_later</mat-icon>
            <mat-label>Stundentyp</mat-label>
            <mat-select formControlName="hourType">
              @for (hourType of assistancePlanHourTypes.length > 0 ? assistancePlanHourTypes : hourTypes; track hourType.id) {
                <mat-option [value]="hourType.id">{{ hourType.title }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </form>
      </div>
    </div>

    <div class="beta-section">
      <div class="beta-section-title">Hilfeplan & Ziele</div>
      <form [formGroup]="secondForm">
        <div class="beta-grid beta-grid-2">
          @if (clientSelected && filteredAssistancePlans.length > 0) {
            <mat-form-field appearance="outline" class="beta-field beta-field-wide">
              <mat-icon matPrefix>event</mat-icon>
              <mat-label>Hilfeplan</mat-label>
              <mat-select formControlName="assistancePlanList">
                @for (plan of filteredAssistancePlans; track plan.id) {
                  <mat-option [value]="plan.id">
                    <div class="beta-plan-option">
                      <div class="beta-plan-date">{{ getDateString(plan) }} | {{ getSponsorName(plan) }}</div>
                    </div>
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          } @else {
            <div class="beta-empty">Hilfeplan ist auswählbar, wenn ein Klient und Datum gewählt wurden.</div>
          }

          @if (assistancePlanSelected) {
            <mat-form-field appearance="outline" class="beta-field beta-field-wide">
              <mat-icon matPrefix>flag</mat-icon>
              <mat-label>Ziele auswählen</mat-label>
              <mat-select formControlName="goalList" multiple>
                @for (goal of selectedAssistancePlan?.goals ?? []; track goal.id) {
                  <mat-option [value]="goal.id">{{ goal.title.length > 50 ? (goal.title | slice:0:50) + '…' : goal.title }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          } @else {
            <div class="beta-empty">Ziele werden angezeigt, sobald ein Hilfeplan gewählt wurde.</div>
          }
        </div>

        @if (selectedGoals.length > 0) {
          <mat-chip-set class="beta-chips">
            @for (goal of selectedGoals; track goal.id) {
              <mat-chip class="beta-chip" removable (removed)="removeGoal(goal.id)">
                <span class="beta-chip-text">{{ goal.title.length > 20 ? (goal.title | slice:0:20) + '…' : goal.title }}</span>
                <button matChipRemove aria-label="Ziel entfernen">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        }
      </form>
    </div>

    <div class="beta-section">
      <div class="beta-section-title">Kategorien</div>
      <form [formGroup]="thirdForm">
        <mat-form-field appearance="outline" class="beta-field">
          <mat-icon matPrefix>local_offer</mat-icon>
          <mat-label>Kategorien auswählen</mat-label>
          <mat-select formControlName="categoryList" multiple>
            @for (category of categories; track category.id) {
              <mat-option [value]="category.id">{{ category.title }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (selectedCategories.length > 0) {
          <mat-chip-set class="beta-chips">
            @for (category of selectedCategories; track category.id) {
              <mat-chip class="beta-chip" removable (removed)="removeCategory(category.id)">
                {{ category.title }}
                <button matChipRemove aria-label="Kategorie entfernen">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        }
      </form>
    </div>

    <div class="beta-section">
      <div class="beta-section-title">Freitext</div>
      <form [formGroup]="thirdForm">
        <mat-form-field appearance="outline" class="beta-field">
          <mat-label>Titel</mat-label>
          <input matInput formControlName="title" placeholder="Titel eingeben">
        </mat-form-field>
        <mat-form-field appearance="outline" class="beta-field">
          <mat-label>Inhalt</mat-label>
          <textarea matInput rows="5" formControlName="content" placeholder="Text hier eingeben..."></textarea>
        </mat-form-field>
      </form>
    </div>

    <div class="beta-footer">
      <div class="beta-status">
        <div class="beta-status-title">Status:</div>
        <div>Hilfeplan: {{ assistancePlanSelected ? 'Gewählt' : 'Nicht gewählt' }}</div>
        <div>Ziele: {{ selectedGoals.length > 0 ? selectedGoals.length : 'Keine' }}</div>
        <div>Kategorien: {{ selectedCategories.length > 0 ? selectedCategories.length : 'Keine' }}</div>
      </div>

      <div class="beta-actions">
        <button mat-raised-button color="primary" (click)="create()">Speichern</button>
        <button mat-stroked-button (click)="location.back()">Abbrechen</button>
        <button mat-stroked-button (click)="resetAll()">Zurücksetzen</button>
      </div>
    </div>
  </div>
</div>
